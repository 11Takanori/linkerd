machine:
  java:
    version: oraclejdk8

general:
  artifacts:
  - "target/scala-2.10/scoverage-report"

dependencies:
  cache_directories:
  - .sbt-launch.jar
  - .gitshas

  override:
  - >
    if [ -n "${TWITTER_DEVELOP}" ]; then
      mkdir -p .gitshas
      export GIT_SHA_DIR=$PWD/.gitshas
      ./project/install-twitter-develop-deps.sh
      ./sbt 'set developTwitterDeps in Global := true' update
    else
      ./sbt update
    fi

test:
  override:
  - >
    if [ -n "${TWITTER_DEVELOP}" ]; then
      ./sbt 'set developTwitterDeps in Global := true' coverage test
      ./sbt 'set developTwitterDeps in Global := true' integration:compile e2e:test assembly
    else
      ./sbt coverage test
      ./sbt integration:compile e2e:test assembly
    fi
  - ./test-config.sh

  post:
  - ./sbt coverageAggregate
  - mkdir -p $CIRCLE_TEST_REPORTS/junit && find . -type f -regex ".*/target/test-reports/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;
